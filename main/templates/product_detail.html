{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="bg-[#E1F5FE] min-h-screen pt-20 pb-20">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

    <!-- Back -->
    <div class="mb-6">
      <a href="{% url 'main:show_main' %}" class="inline-flex items-center gap-2 text-sm text-[#42A5F5] hover:text-[#1E88E5]">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="#42A5F5">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to products
      </a>
    </div>

    <!-- Container -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
      <!-- LEFT: Image gallery -->
      <div class="space-y-4">
        <div class="relative bg-white rounded-2xl border border-[#B3E5FC] overflow-hidden">
          <!-- Main image -->
          <div id="loading-image" class="p-12 text-center">
            <svg class="animate-spin h-8 w-8 text-green-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
          </div>

          <div id="featured-image-container" class="hidden">
            <img id="product-image" src="" alt="" class="w-full h-[70vh] object-contain bg-white">
          </div>
        </div>

        <!-- Thumbnails (will be filled by JS) -->
        <div id="product-thumbs" class="flex items-center gap-3 overflow-x-auto py-2">
          <!-- thumbnails inserted here -->
        </div>
      </div>

      <!-- RIGHT: Product info -->
      <div class="space-y-4">
        <!-- Loading / Error / Article states -->
        <div id="loading-state" class="bg-white rounded-lg border border-gray-200 p-12 text-center">
          <svg class="animate-spin h-8 w-8 text-green-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <p class="text-gray-600 mt-3">Loading product detail...</p>
        </div>

        <div id="error-state" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
          <div class="w-16 h-16 mx-auto mb-4">
            <div class="text-red-500 text-5xl">⚠️</div>
          </div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">Failed to load product</h3>
          <p class="text-gray-500">Please try again later.</p>
        </div>

        <!-- Article Content (hidden until ready) -->
        <article id="article-content" class="bg-white rounded-lg border border-gray-200 overflow-hidden hidden p-6">
          <!-- meta row -->
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <span id="product-category" class="text-xs font-semibold uppercase tracking-widest text-[#42A5F5]">
                <!-- category -->
              </span>
              <span id="product-featured-badge" class="px-3 py-1 rounded bg-[#B3E5FC] text-[#1E88E5] text-xs font-medium hidden">FEATURED</span>
            </div>
            <div class="text-sm text-gray-400">ID: <span id="product-id" class="text-[#1E88E5] font-medium"></span></div>
          </div>

          <!-- title -->
          <h1 id="product-title" class="text-3xl md:text-4xl font-extrabold text-[#1E88E5] leading-tight mb-3">
            <!-- title -->
          </h1>

          <!-- price -->
          <div id="product-price" class="text-2xl font-semibold text-[#42A5F5] mb-4">
            <!-- price -->
          </div>

          <!-- description -->
          <div id="product-description" class="text-gray-700 mb-4">
            <!-- description -->
          </div>

          <!-- owner + actions -->
          <div class="flex items-center gap-3 pt-4" id="product-actions">
            <!-- edit/delete buttons will be inserted here if owner -->
          </div>

          <!-- extra details -->
          <div class="mt-6 pt-4 border-t border-[#E1F5FE]">
            <h3 class="text-lg font-semibold text-[#1E88E5] mb-2">Product Details</h3>
            <ul class="text-gray-700 space-y-2">
              <li><span class="font-medium text-[#1E88E5]">Name:</span> <span id="detail-name"></span></li>
              <li><span class="font-medium text-[#1E88E5]">Category:</span> <span id="detail-category"></span></li>
              <li><span class="font-medium text-[#1E88E5]">Price:</span> <span id="detail-price"></span></li>
              <li><span class="font-medium text-[#1E88E5]">Owner:</span> <span id="detail-owner"></span></li>
              <li><span class="font-medium text-[#1E88E5]">Featured:</span> <span id="detail-featured"></span></li>
            </ul>
          </div>
        </article>
      </div>
    </div>
  </div>
</div>

<script>
/* Configuration */
const PRODUCT_ID = "{{ product.product_id }}";
const PRODUCT_DETAIL_ENDPOINT = `{% url 'main:show_json_by_id' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', PRODUCT_ID);
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

/* DOM Elements */
const loadingState = document.getElementById('loading-state');
const errorState = document.getElementById('error-state');
const articleContent = document.getElementById('article-content');

const productIdEl = document.getElementById('product-id');
const productCategoryEl = document.getElementById('product-category');
const productFeaturedBadge = document.getElementById('product-featured-badge');
const productTitleEl = document.getElementById('product-title');
const productPriceEl = document.getElementById('product-price');
const productDescriptionEl = document.getElementById('product-description');
const productActionsEl = document.getElementById('product-actions');

const detailNameEl = document.getElementById('detail-name');
const detailCategoryEl = document.getElementById('detail-category');
const detailPriceEl = document.getElementById('detail-price');
const detailOwnerEl = document.getElementById('detail-owner');
const detailFeaturedEl = document.getElementById('detail-featured');

const featuredImageContainer = document.getElementById('featured-image-container');
const productImage = document.getElementById('product-image');
const loadingImage = document.getElementById('loading-image');
const thumbsContainer = document.getElementById('product-thumbs');

/* Helpers */
function showState(state) {
  // state: 'loading' | 'error' | 'ready'
  if (loadingState) loadingState.classList.toggle('hidden', state !== 'loading');
  if (errorState) errorState.classList.toggle('hidden', state !== 'error');
  if (articleContent) articleContent.classList.toggle('hidden', state !== 'ready');

  if (featuredImageContainer) featuredImageContainer.classList.toggle('hidden', state !== 'ready');
  if (loadingImage) loadingImage.classList.toggle('hidden', state === 'ready');
}

function getReadableCategoryName(code) {
  const map = {
    ball: 'Ball',
    boot: 'Football Boots',
    kit: 'Kits & Jerseys',
    equi: 'Equipment',
    accs: 'Accessories',
    othr: 'Other Items',
  };
  return map[code] || code || '';
}

/* Toast helper: wait for showToast from toast.js if necessary */
function callShowToast(title, message, type = "info") {
  if (typeof window.showToast === "function") {
    try { window.showToast(title, message, type); } catch (err) { console.error("showToast error:", err); }
    return;
  }
  let tries = 0;
  const maxTries = 40;
  const iv = setInterval(() => {
    tries++;
    if (typeof window.showToast === "function") {
      clearInterval(iv);
      try { window.showToast(title, message, type); } catch (err) { console.error("showToast error after wait:", err); }
    } else if (tries >= maxTries) {
      clearInterval(iv);
      console.warn("showToast not available after waiting; skipping toast.");
    }
  }, 50);
}

/* Render product data into DOM (safe: use textContent where possible) */
function renderProduct(data) {
  // basic fields (choose title/name and content/description fallbacks)
  productIdEl.textContent = data.id || PRODUCT_ID || '';
  productCategoryEl.textContent = getReadableCategoryName(data.category);
  productTitleEl.textContent = data.title || data.name || 'Untitled Product';
  productPriceEl.textContent = data.price ? `Rp ${data.price}` : '';
  productDescriptionEl.textContent = data.content || data.description || '';
  detailNameEl.textContent = data.title || data.name || '';
  detailCategoryEl.textContent = getReadableCategoryName(data.category);
  detailPriceEl.textContent = data.price ? `Rp ${data.price}` : '';
  detailOwnerEl.textContent = data.user_username || (data.user && data.user.username) || 'Anonymous';
  detailFeaturedEl.textContent = data.is_featured ? 'Yes' : 'No';

  // featured badge
  if (productFeaturedBadge) {
    if (data.is_featured) productFeaturedBadge.classList.remove('hidden');
    else productFeaturedBadge.classList.add('hidden');
  }

  // image handling
  if (data.thumbnail) {
    if (productImage) {
      productImage.src = data.thumbnail;
      productImage.alt = data.title || data.name || 'Product image';
    }
    if (featuredImageContainer) featuredImageContainer.classList.remove('hidden');
    if (loadingImage) loadingImage.classList.add('hidden');
  } else {
    if (featuredImageContainer) featuredImageContainer.classList.add('hidden');
    if (loadingImage) loadingImage.classList.add('hidden');
  }

  // thumbnails (if API returns thumbs array, use it; otherwise duplicate thumbnail)
  if (thumbsContainer) {
    thumbsContainer.innerHTML = '';
    const thumbs = Array.isArray(data.thumbs) && data.thumbs.length ? data.thumbs : [data.thumbnail, data.thumbnail, data.thumbnail, data.thumbnail];
    thumbs.forEach((src, idx) => {
      if (!src) return;
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'cursor-pointer flex-shrink-0 w-20 h-20 rounded-lg border border-[#B3E5FC] bg-white p-1 hover:ring-2 hover:ring-[#42A5F5]';
      btn.innerHTML = `<img src="${src}" alt="${(data.title||data.name)||''}" class="w-full h-full object-cover rounded-sm">`;
      btn.addEventListener('click', () => {
        if (productImage) productImage.src = src;
      });
      thumbsContainer.appendChild(btn);
    });
  }

  // owner actions (Edit/Delete) if current user is owner
  if (productActionsEl) {
    productActionsEl.innerHTML = '';
    if (Number(CURRENT_USER_ID) && data.user_id && Number(CURRENT_USER_ID) === Number(data.user_id)) {
      const editLink = `{% url 'main:edit_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', data.id);
      const deleteLink = `{% url 'main:delete_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', data.id);

      productActionsEl.innerHTML = `
        <a href="${editLink}" class="px-4 py-2 bg-[#42A5F5] text-white rounded-lg hover:bg-[#1E88E5] transition mr-2">Edit</a>
        <form action="${deleteLink}" method="post" onsubmit="return confirm('Are you sure you want to delete this product?');" class="inline">
          <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
          <button type="submit" class="px-4 py-2 bg-red-400 text-white rounded-lg hover:bg-red-600 transition">Delete</button>
        </form>
      `;
    }
  }

  // attach delete handler if present (so we can show a toast when user submits delete)
  attachDeleteHandler();

  // document title
  if (data.title || data.name) {
    document.title = `${data.title || data.name} - Product`;
  }
}

/* Attach delete handler to show a toast (do not prevent default submit) */
function attachDeleteHandler() {
  if (!productActionsEl) return;
  const form = productActionsEl.querySelector('form');
  if (!form) return;

  // avoid adding duplicate listeners
  if (form.dataset.toastBound) return;
  form.dataset.toastBound = "1";

  form.addEventListener('submit', (e) => {
    // show immediate toast to inform user delete is in progress
    callShowToast("Deleting product", "The product is being deleted...", "warning");
    // allow form to submit normally (server will redirect)
  });
}

/* Fetch product detail (AJAX) */
async function loadProductDetail() {
  try {
    showState('loading');
    const resp = await fetch(PRODUCT_DETAIL_ENDPOINT, {
      headers: { 'Accept': 'application/json' }
    });
    if (!resp.ok) throw new Error(`Server returned ${resp.status}`);
    const data = await resp.json();
    renderProduct(data);
    showState('ready');

    // toast: success (product loaded)
    callShowToast("Product loaded", "Product details loaded successfully.", "success");

  } catch (err) {
    console.error('Error loading product detail:', err);
    if (errorState) {
      errorState.querySelector('p') && (errorState.querySelector('p').textContent = 'Please try again later.');
    }
    showState('error');

    // toast: error
    callShowToast("Failed to load", "Unable to load product details. Please try again later.", "error");
  }
}

/* Initialize on DOM ready */
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadProductDetail);
} else {
  loadProductDetail();
}
</script>
{% endblock %}
